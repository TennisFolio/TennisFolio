name: Deploy Backend to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build

      - name: Build Docker image
        run: docker build -t tennisfolio .

      - name: Save Docker image to tar
        run: docker save tennisfolio -o tennisfolio.tar

      - name: Copy Docker image to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "tennisfolio.tar"
          target: "/home/ubuntu/TennisFolio/"

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /home/ubuntu/TennisFolio

            echo "ğŸ“¦ [1] application.properties ì¡´ì¬ í™•ì¸"
            if [ ! -f ./src/main/resources/application.properties ]; then
              echo "âŒ ERROR: application.properties íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            echo "ğŸ³ [2] Docker ì´ë¯¸ì§€ ë¡œë”©"
            docker load -i tennisfolio.tar

            echo "ğŸ§¹ [3] ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ"
            docker compose down

            echo "ğŸš€ [4] ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘"
            docker compose up -d

            echo "ğŸ” [5] ë§ˆìš´íŠ¸ í™•ì¸"
            docker exec app ls -l /app/application.properties || echo "âŒ ë§ˆìš´íŠ¸ ì‹¤íŒ¨"